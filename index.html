<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Planetary Assault WebGL</title>
	</head>
	<body>
		
		<div id="container" width="100%" height="100%" margin="0px" padding="0px"></div>
		
	</body>
	
	<script src="js/three.min.js"></script>

	<script type="text/javascript">

		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//
		// - MyParticle Class

		MyParticle = function() {
		//	console.warn( 'MyParticle::ctor' );
			this.pos = new THREE.Vector3(Math.random() * 500 - 250, Math.random() * 500 - 250, Math.random() * 500 - 250);
			this.vel = new THREE.Vector3();
			this.acc = new THREE.Vector3();

			this.velMax = 40.0;
			this.accDecay = 0.0;
			this.velDecay = 1.0;

			this.active = true;
		};

		MyParticle.prototype = {

			constructor: MyParticle,

			update: function ( time ) 
			{
				this.vel.add(this.acc);
				if (this.vel.length() > this.velMax) {
					this.vel.setLength( this.velMax);
				}
				
				this.pos.add(this.vel);

				this.acc.multiplyScalar( this.accDecay );
				this.vel.multiplyScalar( this.velDecay );

			},

			addForce: function( force )
			{
			//	console.warn ('MyParticle::addForce:: '+force.x+', '+force.y);
				this.acc.add( force );
			},

			setActive: function( value )
			{
				this.active = value;
				this.pos.z = 500000; // exceed the draw distance
			}

		};


		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//
		// - MyParticleSystem Class

		MyParticleSystem = function() {
		//	console.warn( 'MyParticleSystem::ctor' );

    		this.G = 0.98;
    		this.center = new THREE.Vector3(0.0, 0.0, 0.0);
    		this.particleCount = 200;

			this.pSystem;
			this.particles = [];
		};

		MyParticleSystem.prototype = {

			constructor: MyParticleSystem,

			initialize: function()
			{
				// now create the individual particles
				var particle;
    			var pGeometry = new THREE.Geometry();
				var pMaterial = new THREE.ParticleBasicMaterial({
					color: 0xFFFFFF,
					size: 20,
					map: THREE.ImageUtils.loadTexture("images/particle.png"),
					blending: THREE.AdditiveBlending,
					transparent: true
				});

				for(var i = 0; i < this.particleCount; i++) {
				
					// create a particle
					particle = new MyParticle();
					// add it to the geometry
					pGeometry.vertices.push(particle.pos);
					this.particles.push(particle);
				}
				
				// create the particle system
				this.pSystem = new THREE.ParticleSystem(pGeometry, pMaterial);
				this.pSystem.sortParticles = true;
				
				// auto-add to the scene
				scene.add(this.pSystem);
			},

			update: function()
			{
				var p, i;
				for(i = 0; i < this.particleCount; i++) {
					p = this.particles[i];
					if (p.active) {
						this.gravity(p);
						this.air(p);
					}
					p.update();
				}

				// flag to the particle system that we've changed its vertices.
				this.pSystem.geometry.verticesNeedUpdate = true;
			},

			gravity: function( p )
			{
				var f = p.pos.clone();
				f.sub(this.center);
				f.normalize();
				f.multiplyScalar(-this.G);
				p.addForce(f);
			},

			air: function( p )
			{
				var f = p.vel.clone(); 
				f.multiplyScalar(-.02);
				p.addForce(f);
			},

			impulse: function( value )
			{
				var p, i;
				for(i = 0; i < this.particleCount; i++) {
					p = this.particles[i];
					p.velocity.multiplyScalar(value);
				}
			},

			turn: function( value )
			{
				var p, i, f;
				var axis = new THREE.Vector3(1, 0, 0);

				for(i = 0; i < this.particleCount; i++) {
					p = this.particles[i];
					
					f = p.pos.clone();
					f.sub(center);
					f.applyAxisAngle(axis, Math.PI / 2);
					f.multiplyScalar(value);

					p.addForce(f);
					//p.velocity.add(value);
				}
			}


		}


		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//
		// - Main Program


		// - RENDERING ATTRIBUTES

		var scene;
		var camera;
		var renderer;

		// width and height of the scene :
		var WIDTH = window.innerWidth;
		var HEIGHT = window.innerHeight;

		// camera attributes
		var VIEW_ANGLE = 45;
		var ASPECT = WIDTH / HEIGHT;
		var NEAR = 0.1;
		var FAR = 10000;

		// - PROGRAM ATTRIBUTES

		var particleSystem;





		init();
		update();

		function init()
		{
			// Create the scene
			scene = new THREE.Scene();
			
			// Create a WebGL renderer and add it to the DOM.
			renderer = new THREE.WebGLRenderer();
			renderer.setSize(WIDTH, HEIGHT);
			renderer.setClearColor(0x333F47, 1);
			document.getElementById("container").appendChild(renderer.domElement);

			// Create a camera, zoom it out from the model a bit, and add it to the scene.
			camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
			camera.position.z = 300;
			scene.add(camera);


			// Create an event listener that resizes the renderer with the browser window.
		    window.addEventListener('resize', function() {
		    	WIDTH = window.innerWidth,
		        HEIGHT = window.innerHeight;
		        renderer.setSize(WIDTH, HEIGHT);
		        camera.aspect = WIDTH / HEIGHT;
		        camera.updateProjectionMatrix();
		    });

			/*
			// Create a light, set its position, and add it to the scene.
			var light = new THREE.PointLight(0xffffff);
				light.position.set(-100,200,100);
				scene.add(light);
			}*/

			particleSystem = new MyParticleSystem();
			particleSystem.initialize();
		}

		// Renders the scene and updates the render as needed.
    	function update() {
    		//console.warn( 'update' );

	      	// Update
	      	particleSystem.update();

			// Render the scene.
			renderer.render(scene, camera);

    		// set up the next call
			requestAnimationFrame(update);
		}




		document.onkeydown = keyDown;
		function keyDown(e) {

		    e = e || window.event;

		    console.warn(e.keyCode+', '+e.keyChar);

		    if (e.keyCode == '65') { // a
		        
		    }
		    else if (e.keyCode == '90') { // z
		        
		    }
		    else if (e.keyCode == '69') { // e
				
		    }
		    else if (e.keyCode == '73') { // i
				
		    }
		    else if (e.keyCode == '79') { // o
				
		    }
		    else if (e.keyCode == '80') { // p
				
		    }

		}


		// Smart animation system
		window.requestAnimFrame = (function(){
		    return  window.requestAnimationFrame       ||
		            window.webkitRequestAnimationFrame ||
		            window.mozRequestAnimationFrame    ||
		            window.oRequestAnimationFrame      || 
		            window.msRequestAnimationFrame     || 
		            function(callback){
		              window.setTimeout(callback, 1000 / 60);
		            };
		})();

	</script>
</html>